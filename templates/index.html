{% extends "base.html" %}
{% block title %}Stycly - Noleggio abiti per bambini{% endblock %}

{% block content %}
<section id="home" class="stycly-hero hero-split">
  <div class="hero-bg-gradient"></div>
  <div class="hero-shade"></div>
  <div class="stycly-hero-content">
    <div class="hero-pill">Non solo capi</div>
    <div class="typewriter">
      <h1 class="typewriter-text">
        Noleggia capi, scarpe e props per set creativi
      </h1>
    </div>
    <p class="hero-subtitle">
      Selezioni pronte: capi singoli, calzature e oggetti di scena per shooting, eventi e set.
      Nessun outfit preimpostato: componi tu ciò che serve.
    </p>
    <div class="hero-highlights">
      <span>Prodotti come nuovi</span>
      <span>Noleggio rapido e flessibile</span>
      <span>Flip-card fronte/retro</span>
    </div>
  </div>
  <div class="hero-visual hero-collage">
    <div class="hero-shot vertical" style="background-image: url('{{ url_for('immagini', filename='shoot1.jpg') }}');"></div>
    <div class="hero-shot horizontal" style="background-image: url('{{ url_for('immagini', filename='shoot3.jpg') }}');"></div>
  </div>
  <a href="#featured" class="hero-arrow bouncy" aria-label="Scorri ai featured">
    <svg height="30" width="60" viewBox="0 0 50 25">
      <polygon points="0,0 25,10 50,0 25,25" fill="rgba(255,255,255,.7)" stroke-width="0" />
    </svg>
  </a>
</section>

{% if featured_capi %}
<section id="featured" class="section-band featured-band">
  <div class="section-inner">
    <div class="stycly-featured-header">
      <h2>Featured Products</h2>
      <a href="#products" class="view-all-link">Vai ai prodotti</a>
    </div>
    <div class="stycly-featured-grid">
      {% for capo in featured_capi %}
      <article class="stycly-featured-card">
        <div class="stycly-featured-card-img">
          <img
            src="{{ url_for('immagini', filename=(capo['immagine'] or '').split('/')[-1]) }}"
            alt="{{ capo['tipologia'] or '' }}"
            draggable="false">
          <div class="stycly-featured-card-overlay">
            <button type="button"
              class="icon-btn featured-cart-open"
              data-capo='{{ capo|tojson|safe }}'>
              <svg class="icon-20">
                <use xlink:href="#shopping-carriage"></use>
              </svg>
            </button>
            <button type="button"
              class="icon-btn featured-info-btn"
              data-capo='{{ capo|tojson|safe }}'>
              <svg class="icon-20">
                <use xlink:href="#quick-view"></use>
              </svg>
            </button>
          </div>
        </div>
        <div class="stycly-featured-card-body">
          <h3 class="card-title">
            {{ capo['categoria'] }} - {{ capo['tipologia'] }}
          </h3>
          <p class="card-meta">
            Taglia: {{ capo['taglia'] or '-' }}
            {% if capo['colore'] %} · Colore: {{ capo['colore'] }}{% endif %}
            {% if capo['brand'] %} · Brand: {{ capo['brand'] }}{% endif %}
          </p>
        </div>
      </article>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

<section id="products" class="section-band-light">
  <div class="section-inner">
    <div class="wardrobe-view-layout">
      <aside class="wardrobe-filters">
        <h3>Filtra capi</h3>
        <div style="margin-bottom: 1.2rem;">
          <label style="font-size: 0.9rem; font-weight: 500;">Categoria</label>
          <select class="filter-select" data-filter="categoria" style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Tutte</option>
            {% for cat in capi|map(attribute='categoria')|unique %}
              {% if cat %}<option value="{{ cat }}">{{ cat }}</option>{% endif %}
            {% endfor %}
          </select>
        </div>
        <div style="margin-bottom: 1.2rem;">
          <label style="font-size: 0.9rem; font-weight: 500;">Taglia</label>
          <select class="filter-select" data-filter="taglia" style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Tutte</option>
            {% for t in capi|map(attribute='taglia')|unique %}
              {% if t %}<option value="{{ t }}">{{ t }}</option>{% endif %}
            {% endfor %}
          </select>
        </div>
        <div style="margin-bottom: 1.2rem;">
          <label style="font-size: 0.9rem; font-weight: 500;">Brand</label>
          <select class="filter-select" data-filter="brand" style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Tutti</option>
            {% for b in capi|map(attribute='brand')|unique %}
              {% if b %}<option value="{{ b }}">{{ b }}</option>{% endif %}
            {% endfor %}
          </select>
        </div>
        <div style="margin-bottom: 1.2rem;">
          <label style="font-size: 0.9rem; font-weight: 500;">Destinazione</label>
          <select class="filter-select" data-filter="destinazione" style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Tutte</option>
            {% for d in capi|map(attribute='destinazione')|unique %}
              {% if d %}<option value="{{ d }}">{{ d }}</option>{% endif %}
            {% endfor %}
          </select>
        </div>
        <button onclick="resetFilters()" style="padding: 0.5rem 1rem; background-color: #e6ecf9; border: none; border-radius: 6px; color: #2b4ca3; font-weight: 500; cursor: pointer; margin-top: 1rem; width: 100%;">Reset filtri</button>
      </aside>
      <div class="wardrobe-main">
        <h2>Products</h2>
        <p style="margin-top: 0.5rem; font-size: 0.95rem; color: #555;">Tutti i capi caricati dagli Admin.</p>
        <p id="item-count" style="margin-top: 0.5rem; font-size: 0.95rem; color: #555;"></p>
        <div class="wardrobe-grid wardrobe-grid-3col">
          {% if capi %}
            {% for capo in capi %}
            <div class="capo-flip-card" data-capo='{{ capo|tojson|safe }}'>
              <div class="capo-flip-inner">
                <div class="capo-flip-front">
                  <img src="{{ url_for('immagini', filename=(capo['immagine'] or '').split('/')[-1]) }}" alt="fronte" class="capo-img">
                </div>
                <div class="capo-flip-back">
                  {% if capo['immagine2'] %}
                    <img src="{{ url_for('immagini', filename=(capo['immagine2'] or '').split('/')[-1]) }}" alt="retro" class="capo-img">
                  {% else %}
                    <p style="text-align:center; font-size: 0.8rem;">Nessuna retro immagine</p>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <p>Nessun capo presente nei wardrobe pubblici al momento.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal dettagli capo (sezione products) -->
<div id="detail-modal" class="stycly-modal" style="display:none;">
  <div class="stycly-modal-content" style="max-width: 900px;">
    <button class="stycly-modal-close" onclick="closeDetailPopup()">&times;</button>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
      <div style="flex: 1; text-align:center;">
        <img id="popup-image" src="" alt="Capo" style="max-width: 100%; max-height: 380px; border-radius: 8px;">
        <div style="margin-top: 10px; display: flex; gap: 0.5rem; justify-content: center;">
          <button onclick="showFront()" class="capo-icon-btn" title="Fronte">F</button>
          <button onclick="showBack()" class="capo-icon-btn" title="Retro">R</button>
        </div>
      </div>
      <div id="popup-details" style="flex:1; font-size: 0.95rem;"></div>
    </div>
  </div>
</div>

<!-- Modal featured quickview -->
<div id="featured-detail-modal" class="quickview-overlay" style="display:none;">
  <div class="quickview-modal">
    <button class="quickview-close" id="quickview-close-btn" type="button">&times;</button>
    <div class="quickview-layout">
      <div class="quickview-image-wrap">
        <img id="quickview-image" src="" alt="Capo">
      </div>
      <div class="quickview-info">
        <h2 id="quickview-title" class="quickview-title"></h2>
        <p id="quickview-subtitle" class="quickview-subtitle"></p>
        <div id="quickview-description" class="quickview-description"></div>
        <ul class="quickview-meta">
          <li><strong>Taglia:</strong> <span id="quickview-taglia"></span></li>
          <li><strong>Colore:</strong> <span id="quickview-colore"></span></li>
          <li><strong>Brand:</strong> <span id="quickview-brand"></span></li>
          <li><strong>Destinazione:</strong> <span id="quickview-destinazione"></span></li>
          <li><strong>Fit:</strong> <span id="quickview-fit"></span></li>
          <li><strong>Disponibilità:</strong> <span id="quickview-dispo"></span></li>
        </ul>
        <div class="quickview-actions">
          <div class="quickview-qty">
            <button type="button" id="quickview-minus" class="qty-btn">-</button>
            <span id="quickview-qty-value" class="qty-value">1</span>
            <button type="button" id="quickview-plus" class="qty-btn">+</button>
          </div>
          <button type="button" id="quickview-add-cart" class="quickview-add-btn">Add to cart</button>
          <button type="button" id="quickview-proceed" class="quickview-add-btn secondary">Procedi con l'ordine</button>
        </div>
        <p class="quickview-categories"><strong>Categoria:</strong> <span id="quickview-categoria"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- Mini cart popup per icona carrello featured -->
<div id="mini-cart-overlay" class="cart-overlay cart-hidden">
  <div class="cart-modal">
    <div class="cart-header">
      <h2>Seleziona quantità</h2>
      <button type="button" class="cart-close" id="mini-cart-close" aria-label="Chiudi mini carrello">
        <svg class="icon-20"><use xlink:href="#close"></use></svg>
      </button>
    </div>
    <div class="cart-body">
      <div class="mini-cart-item">
        <div class="mini-cart-img">
          <img id="mini-cart-img" src="" alt="Prodotto">
        </div>
        <div class="mini-cart-info">
          <div class="mini-cart-title" id="mini-cart-title"></div>
          <div class="mini-cart-qty">
            <button type="button" class="qty-btn" id="mini-cart-minus">-</button>
            <span class="qty-value" id="mini-cart-qty">1</span>
            <button type="button" class="qty-btn" id="mini-cart-plus">+</button>
          </div>
        </div>
      </div>
      <div class="cart-actions">
        <button type="button" class="cart-btn primary" id="mini-cart-add">Aggiungi al carrello</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// helper immagini
function buildImageURLHome(filename) {
  if (!filename) return "";
  const cleanName = filename.toString().split("/").pop();
  return "/immagini/" + cleanName;
}

let qvFront = "";
let qvBack  = "";
let qvQty   = 1;
let qvProduct = null;
let miniProduct = null;

function openFeaturedDetail(capo) {
  qvFront = capo.immagine;
  qvBack  = capo.immagine2 || "";
  qvQty   = 1;
  const title = (capo.categoria || '') + (capo.tipologia ? ' - ' + capo.tipologia : '');
  document.getElementById('quickview-title').textContent = title;
  document.getElementById('quickview-subtitle').textContent = capo.brand || '';
  document.getElementById('quickview-description').textContent = capo.destinazione ? ('Perfetto per: ' + capo.destinazione) : '';
  document.getElementById('quickview-taglia').textContent       = capo.taglia || '-';
  document.getElementById('quickview-colore').textContent       = capo.colore || '-';
  document.getElementById('quickview-brand').textContent        = capo.brand || '-';
  document.getElementById('quickview-destinazione').textContent = capo.destinazione || '-';
  document.getElementById('quickview-fit').textContent          = capo.fit || '-';
  document.getElementById('quickview-dispo').textContent        = capo.disponibilita || 1;
  document.getElementById('quickview-categoria').textContent    = capo.categoria || '-';
  document.getElementById('quickview-image').src = buildImageURLHome(qvFront);
  document.getElementById('quickview-qty-value').textContent = qvQty;
  qvProduct = { id: capo.id, name: title, img: (capo.immagine || '').toString().split('/').pop() };
  document.getElementById('featured-detail-modal').style.display = 'flex';
}

function closeFeaturedDetail() {
  document.getElementById('featured-detail-modal').style.display = 'none';
}

// Modal prodotti (sezione products)
let frontImg = "";
let backImg  = "";

function buildImageURL(filename) {
  if (!filename) return "";
  const cleanName = filename.toString().split("/").pop();
  return "/immagini/" + cleanName;
}

function openDetailPopup(capo) {
  frontImg = capo.immagine;
  backImg  = capo.immagine2 || "";
  document.getElementById('popup-image').src = buildImageURL(frontImg);
  document.getElementById('popup-details').innerHTML = `
    <p><b>Categoria:</b> ${capo.categoria || ''}</p>
    <p><b>Tipologia:</b> ${capo.tipologia || ''}</p>
    <p><b>Taglia:</b> ${capo.taglia || ''}</p>
    <p><b>Colore:</b> ${capo.colore || ''}</p>
    <p><b>Brand:</b> ${capo.brand || ''}</p>
    <p><b>Destinazione:</b> ${capo.destinazione || ''}</p>
    ${capo.fit ? `<p><b>Fit:</b> ${capo.fit}</p>` : ''}
    <p><b>Disponibilità:</b> ${capo.disponibilita || 1}</p>
  `;
  document.getElementById("detail-modal").style.display = "flex";
}

function closeDetailPopup() {
  document.getElementById("detail-modal").style.display = "none";
}

function showFront() { if (frontImg) document.getElementById('popup-image').src = buildImageURL(frontImg); }
function showBack()  { if (backImg)  document.getElementById('popup-image').src = buildImageURL(backImg); }

function applyFilters() {
  const filters = {};
  document.querySelectorAll('.filter-select').forEach(select => {
    const key = select.dataset.filter;
    const val = select.value;
    if (val) filters[key] = val;
  });
  let visibleCount = 0;
  document.querySelectorAll('.capo-flip-card').forEach(card => {
    const capo = JSON.parse(card.getAttribute('data-capo'));
    const match = Object.entries(filters).every(([key, val]) => {
      const v = (capo[key] || '').toString().toLowerCase();
      return v === val.toString().toLowerCase();
    });
    card.style.display = match ? 'flex' : 'none';
    if (match) visibleCount++;
  });
  const ic = document.getElementById("item-count");
  if (ic) ic.textContent = `${visibleCount} cap${visibleCount === 1 ? 'o' : 'i'} trovati`;
}

function resetFilters() {
  document.querySelectorAll('.filter-select').forEach(select => { select.value = ""; });
  applyFilters();
}

function showToast(message) {
  let container = document.querySelector('.toast-container');
  if (!container) {
    container = document.createElement('div');
    container.className = 'toast-container';
    document.body.appendChild(container);
  }
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  container.appendChild(toast);
  requestAnimationFrame(() => toast.classList.add('show'));
  setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 2200);
}

document.addEventListener('DOMContentLoaded', () => {
  // quickview featured info
  document.querySelectorAll('.featured-info-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const capo = JSON.parse(this.getAttribute('data-capo'));
      openFeaturedDetail(capo);
    });
  });

  const modal = document.getElementById('featured-detail-modal');
  if (modal) {
    document.getElementById('quickview-close-btn').addEventListener('click', closeFeaturedDetail);
    modal.addEventListener('click', (e) => { if (e.target.id === 'featured-detail-modal') closeFeaturedDetail(); });
  }

  const qvImage = document.getElementById('quickview-image');
  if (qvImage) {
    qvImage.addEventListener('click', () => {
      if (!qvBack) return;
      const current = qvImage.getAttribute('src');
      const frontURL = buildImageURLHome(qvFront);
      const backURL  = buildImageURLHome(qvBack);
      qvImage.src = (current === frontURL) ? backURL : frontURL;
    });
  }

  const minus = document.getElementById('quickview-minus');
  const plus = document.getElementById('quickview-plus');
  if (minus && plus) {
    minus.addEventListener('click', () => { if (qvQty > 1) qvQty--; document.getElementById('quickview-qty-value').textContent = qvQty; });
    plus.addEventListener('click', () => { qvQty++; document.getElementById('quickview-qty-value').textContent = qvQty; });
  }

  const addCartBtn = document.getElementById('quickview-add-cart');
  const proceedBtn = document.getElementById('quickview-proceed');
  if (addCartBtn) {
    addCartBtn.addEventListener('click', () => {
      if (!qvProduct || typeof window.styclyAddToCart !== 'function') return alert('Carrello non disponibile al momento.');
      for (let i = 0; i < qvQty; i++) window.styclyAddToCart(qvProduct);
      showToast('Articolo aggiunto al carrello');
      closeFeaturedDetail();
    });
  }
  if (proceedBtn) {
    proceedBtn.addEventListener('click', () => {
      if (!qvProduct) return;
      if (typeof window.styclyAddToCart === 'function') window.styclyAddToCart(qvProduct);
      if (typeof window.styclyOpenCart === 'function') window.styclyOpenCart();
      closeFeaturedDetail();
    });
  }

  // products section
  document.querySelectorAll('.capo-flip-card').forEach(card => {
    card.addEventListener('click', function () {
      const capo = JSON.parse(this.getAttribute('data-capo'));
      openDetailPopup(capo);
    });
  });
  document.querySelectorAll('.filter-select').forEach(select => select.addEventListener('change', applyFilters));
  applyFilters();
});
</script>
<script>
// Mini cart per icona carrello nei featured
document.addEventListener('DOMContentLoaded', () => {
  const miniOverlay = document.getElementById('mini-cart-overlay');
  const miniClose = document.getElementById('mini-cart-close');
  const miniImg = document.getElementById('mini-cart-img');
  const miniTitle = document.getElementById('mini-cart-title');
  const miniQtyEl = document.getElementById('mini-cart-qty');
  const miniMinus = document.getElementById('mini-cart-minus');
  const miniPlus = document.getElementById('mini-cart-plus');
  const miniAdd = document.getElementById('mini-cart-add');

  function openMini(product) {
    miniProduct = { ...product };
    if (miniImg) miniImg.src = "/immagini/" + (product.img || "");
    if (miniTitle) miniTitle.textContent = product.name || "";
    if (miniQtyEl) miniQtyEl.textContent = product.qty || 1;
    if (miniOverlay) miniOverlay.classList.remove('cart-hidden');
  }
  function closeMini() {
    if (miniOverlay) miniOverlay.classList.add('cart-hidden');
    miniProduct = null;
  }

  document.querySelectorAll('.featured-cart-open').forEach(btn => {
    btn.addEventListener('click', function () {
      const capo = JSON.parse(this.getAttribute('data-capo'));
      openMini({
        id: capo.id,
        name: (capo.categoria || '') + (capo.tipologia ? ' - ' + capo.tipologia : ''),
        img: (capo.immagine || '').toString().split('/').pop(),
        qty: 1,
      });
    });
  });

  if (miniClose) miniClose.addEventListener('click', closeMini);
  if (miniOverlay) miniOverlay.addEventListener('click', (e) => { if (e.target === miniOverlay) closeMini(); });
  if (miniMinus) miniMinus.addEventListener('click', () => {
    let qty = parseInt(miniQtyEl.textContent, 10) || 1;
    qty = Math.max(1, qty - 1);
    miniQtyEl.textContent = qty;
    if (miniProduct) miniProduct.qty = qty;
  });
  if (miniPlus) miniPlus.addEventListener('click', () => {
    let qty = parseInt(miniQtyEl.textContent, 10) || 1;
    qty += 1;
    miniQtyEl.textContent = qty;
    if (miniProduct) miniProduct.qty = qty;
  });
  if (miniAdd) miniAdd.addEventListener('click', () => {
    if (!miniProduct || typeof window.styclyAddToCart !== 'function') return;
    for (let i = 0; i < (miniProduct.qty || 1); i++) window.styclyAddToCart(miniProduct);
    showToast('Articolo aggiunto al carrello');
    closeMini();
  });
});
</script>
{% endblock %}
