{% extends "base.html" %}
{% block title %}Stycly – Noleggio abiti per bambini{% endblock %}

{% block content %}
<section class="stycly-hero">
  <div class="stycly-hero-content">
    <h1>Crea il tuo guardaroba digitale</h1>
    <strong>e scopri il noleggio abiti per bambini</strong>

    <p>
      Stycly è il tuo guardaroba online di outfit per bambini pensato per shooting,
      eventi speciali e campagne creative.  
      Scegli i capi, prenota il noleggio e pensa solo alle foto.
    </p>

    <!-- CTA verso pagina prodotti -->
    <a href="{{ url_for('products') }}" class="stycly-cta-btn">
      Products
    </a>
  </div>
</section>

{% if featured_capi %}
<section class="stycly-featured">
  <div class="stycly-featured-header">
    <h2>Featured Products</h2>
    <a href="{{ url_for('products') }}" class="view-all-link">View all</a>
  </div>

  <div class="stycly-featured-grid">

    {% for capo in featured_capi %}
    <article class="stycly-featured-card">

      <!-- IMMAGINE QUADRATA CON OVERLAY -->
      <div class="stycly-featured-card-img">
        <img
          src="{{ url_for('immagini', filename=(capo['immagine'] or '').split('/')[-1]) }}"
          alt="{{ capo['tipologia'] or '' }}"
          draggable="false"
        >

        <!-- OVERLAY CON ANIMAZIONE TEMPLATE -->
        <div class="stycly-featured-card-overlay">

          <!-- ICONA CARRELLO -->
          <button type="button"
            class="icon-btn"
            data-id="{{ capo['id'] }}"
            data-name="{{ capo['categoria'] }} - {{ capo['tipologia'] }}"
            data-img="{{ (capo['immagine'] or '').split('/')[-1] }}"
            >
            <svg class="icon-20">
              <use xlink:href="#shopping-carriage"></use>
            </svg>
          </button>

          <!-- ICONA QUICK VIEW -->
          <button type="button"
            class="icon-btn featured-info-btn"
            data-capo='{{ capo|tojson|safe }}'>
            <svg class="icon-20">
              <use xlink:href="#quick-view"></use>
            </svg>
          </button>

        </div>
      </div>

      <!-- INFO SOTTO -->
      <div class="stycly-featured-card-body">
        <h3 class="card-title">
          {{ capo['categoria'] }} – {{ capo['tipologia'] }}
        </h3>

        <p class="card-meta">
          Taglia: {{ capo['taglia'] or '-' }}
          {% if capo['colore'] %} · Colore: {{ capo['colore'] }}{% endif %}
          {% if capo['brand'] %} · Brand: {{ capo['brand'] }}{% endif %}
        </p>
      </div>

    </article>
    {% endfor %}

  </div>
</section>
{% endif %}


<!-- QUICK VIEW MODAL stile template ecommerce -->
<div id="featured-detail-modal" class="quickview-overlay" style="display:none;">
  <div class="quickview-modal">
    <button class="quickview-close" id="quickview-close-btn" type="button">&times;</button>

    <div class="quickview-layout">
      <div class="quickview-image-wrap">
        <img id="quickview-image" src="" alt="Capo">
      </div>

      <div class="quickview-info">
        <h2 id="quickview-title" class="quickview-title"></h2>

        <p id="quickview-subtitle" class="quickview-subtitle"></p>

        <div id="quickview-description" class="quickview-description"></div>

        <ul class="quickview-meta">
          <li><strong>Taglia:</strong> <span id="quickview-taglia"></span></li>
          <li><strong>Colore:</strong> <span id="quickview-colore"></span></li>
          <li><strong>Brand:</strong> <span id="quickview-brand"></span></li>
          <li><strong>Destinazione:</strong> <span id="quickview-destinazione"></span></li>
          <li><strong>Fit:</strong> <span id="quickview-fit"></span></li>
          <li><strong>Disponibilità:</strong> <span id="quickview-dispo"></span></li>
        </ul>

        <!-- quantità + add to cart stile template -->
        <div class="quickview-actions">
          <div class="quickview-qty">
            <button type="button" id="quickview-minus" class="qty-btn">-</button>
            <span id="quickview-qty-value" class="qty-value">1</span>
            <button type="button" id="quickview-plus" class="qty-btn">+</button>
          </div>
          <button type="button" id="quickview-add-cart" class="quickview-add-btn">
            Add to cart
          </button>
        </div>

        <p class="quickview-categories">
          <strong>Categoria:</strong>
          <span id="quickview-categoria"></span>
        </p>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// --- helper per immagini (stessa logica di public_wardrobe) ---
function buildImageURLHome(filename) {
  if (!filename) return "";
  const cleanName = filename.toString().split("/").pop();
  return "/immagini/" + cleanName;
}

let qvFront = "";
let qvBack  = "";
let qvQty   = 1;
let qvProduct = null;

function openFeaturedDetail(capo) {
  qvFront = capo.immagine;
  qvBack  = capo.immagine2 || "";
  qvQty   = 1;

  const title = (capo.categoria || '') + (capo.tipologia ? ' - ' + capo.tipologia : '');
  document.getElementById('quickview-title').textContent = title;

  document.getElementById('quickview-subtitle').textContent =
    capo.brand ? capo.brand : '';

  document.getElementById('quickview-description').textContent =
    capo.destinazione ? ('Perfetto per: ' + capo.destinazione) : '';

  document.getElementById('quickview-taglia').textContent       = capo.taglia || '-';
  document.getElementById('quickview-colore').textContent       = capo.colore || '-';
  document.getElementById('quickview-brand').textContent        = capo.brand || '-';
  document.getElementById('quickview-destinazione').textContent = capo.destinazione || '-';
  document.getElementById('quickview-fit').textContent          = capo.fit || '-';
  document.getElementById('quickview-dispo').textContent        = capo.disponibilita || 1;
  document.getElementById('quickview-categoria').textContent    = capo.categoria || '-';

  document.getElementById('quickview-image').src = buildImageURLHome(qvFront);
  document.getElementById('quickview-qty-value').textContent = qvQty;

  // oggetto prodotto per il carrello
  qvProduct = {
    id: capo.id,
    name: title,
    img: (capo.immagine || '').toString().split('/').pop()
  };

  document.getElementById('featured-detail-modal').style.display = 'flex';
}

function closeFeaturedDetail() {
  document.getElementById('featured-detail-modal').style.display = 'none';
}

function showFeaturedFront() {
  if (qvFront) {
    document.getElementById('quickview-image').src = buildImageURLHome(qvFront);
  }
}

function showFeaturedBack() {
  if (qvBack) {
    document.getElementById('quickview-image').src = buildImageURLHome(qvBack);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // apertura quick view
  document.querySelectorAll('.featured-info-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const capo = JSON.parse(this.getAttribute('data-capo'));
      openFeaturedDetail(capo);
    });
  });

  // chiusura quick view
  document.getElementById('quickview-close-btn').addEventListener('click', closeFeaturedDetail);
  document.getElementById('featured-detail-modal').addEventListener('click', (e) => {
    if (e.target.id === 'featured-detail-modal') {
      closeFeaturedDetail();
    }
  });

  // cambio fronte/retro cliccando sull'immagine
  document.getElementById('quickview-image').addEventListener('click', () => {
    // toggla fronte/retro se esiste
    if (!qvBack) return;
    const current = document.getElementById('quickview-image').getAttribute('src');
    const frontURL = buildImageURLHome(qvFront);
    const backURL  = buildImageURLHome(qvBack);
    document.getElementById('quickview-image').src =
      (current === frontURL) ? backURL : frontURL;
  });

  // gestione quantità
  document.getElementById('quickview-minus').addEventListener('click', () => {
    if (qvQty > 1) {
      qvQty--;
      document.getElementById('quickview-qty-value').textContent = qvQty;
    }
  });

  document.getElementById('quickview-plus').addEventListener('click', () => {
    qvQty++;
    document.getElementById('quickview-qty-value').textContent = qvQty;
  });

  // Add to cart dal popup
  document.getElementById('quickview-add-cart').addEventListener('click', () => {
    if (!qvProduct) return;
    if (typeof window.styclyAddToCart !== 'function') {
      alert('Carrello non disponibile al momento.');
      return;
    }

    for (let i = 0; i < qvQty; i++) {
      window.styclyAddToCart(qvProduct);
    }
    closeFeaturedDetail();
  });
});


/* ============================================================
   MIGLIORIE QUICKVIEW (animazioni + modal smooth)
============================================================ */

// Fade elegante per cambio immagine fronte/retro
function qvFadeImage(newSrc) {
  const img = document.getElementById("quickview-image");
  img.classList.remove("fade-in");
  img.classList.add("fade-out");

  setTimeout(() => {
    img.src = newSrc;
    img.classList.remove("fade-out");
    img.classList.add("fade-in");
  }, 150);
}

// SOVRASCRIVE SOLO LA PARTE VISIVA, NON LA LOGICA
const originalOpen = openFeaturedDetail;
openFeaturedDetail = function(capo) {
  originalOpen(capo);

  const overlay = document.getElementById('featured-detail-modal');
  const modal   = overlay.querySelector('.quickview-modal');

  // Reset classi (per riaprire con animazione)
  overlay.classList.remove('open');
  modal.classList.remove('open');

  // Attiva animazione
  setTimeout(() => {
    overlay.classList.add('open');
    modal.classList.add('open');
  }, 10);
};

// Chiusura animata
const originalClose = closeFeaturedDetail;
closeFeaturedDetail = function() {
  const overlay = document.getElementById('featured-detail-modal');
  const modal   = overlay.querySelector('.quickview-modal');

  modal.classList.remove('open');
  overlay.classList.remove('open');

  setTimeout(() => {
    originalClose();
  }, 280);
};

// Rende front/back elegante
document.getElementById('quickview-image').addEventListener('click', () => {
  if (!qvBack) return;
  const current = document.getElementById("quickview-image").src;
  const front   = buildImageURLHome(qvFront);
  const back    = buildImageURLHome(qvBack);

  qvFadeImage(current === front ? back : front);
});



</script>
{% endblock %}





