{% extends "base.html" %}
{% block title %}Stycly - Noleggio abiti per bambini{% endblock %}

{% block content %}
<section id="home" class="stycly-hero hero-split">
  <div class="hero-bg-gradient"></div>
  <div class="stycly-hero-content">
    <div class="hero-pill">Non solo capi</div>
    <div class="typewriter">
      <h1 class="typewriter-text">
        Noleggia capi, scarpe e props per set creativi
      </h1>
    </div>

    <p class="hero-subtitle">
      Selezioni pronte: capi singoli, calzature e oggetti di scena per shooting, eventi e set.
      Nessun outfit preimpostato: componi tu ciò che serve.
    </p>

    <div class="hero-highlights">
      <span>Prodotti come nuovi</span>
      <span>Noleggio rapido e flessibile</span>
      <span>Flip-card fronte/retro</span>
    </div>

  </div>
  <div class="hero-visual hero-collage">
    <div class="hero-shot vertical" style="background-image: url('{{ url_for('immagini', filename='shoot1.jpg') }}');"></div>
    <div class="hero-shot horizontal" style="background-image: url('{{ url_for('immagini', filename='shoot3.jpg') }}');"></div>
  </div>
</section>

{% if featured_capi %}
<section id="featured" class="section-band featured-band">
  <div class="section-inner">
    <div class="stycly-featured-header">
      <h2>Featured Products</h2>
      <a href="#products" class="view-all-link">Vai ai prodotti</a>
    </div>

    <div class="stycly-featured-grid">
      {% for capo in featured_capi %}
      <article class="stycly-featured-card">
        <div class="stycly-featured-card-img">
          <img
            src="{{ url_for('immagini', filename=(capo['immagine'] or '').split('/')[-1]) }}"
            alt="{{ capo['tipologia'] or '' }}"
            draggable="false">

          <div class="stycly-featured-card-overlay">
            <button type="button"
              class="icon-btn add-to-cart"
              data-id="{{ capo['id'] }}"
              data-name="{{ capo['categoria'] }} - {{ capo['tipologia'] }}"
              data-img="{{ (capo['immagine'] or '').split('/')[-1] }}">
              <svg class="icon-20">
                <use xlink:href="#shopping-carriage"></use>
              </svg>
            </button>

            <button type="button"
              class="icon-btn featured-info-btn"
              data-capo='{{ capo|tojson|safe }}'>
              <svg class="icon-20">
                <use xlink:href="#quick-view"></use>
              </svg>
            </button>
          </div>
        </div>

        <div class="stycly-featured-card-body">
          <h3 class="card-title">
            {{ capo['categoria'] }} - {{ capo['tipologia'] }}
          </h3>

          <p class="card-meta">
            Taglia: {{ capo['taglia'] or '-' }}
            {% if capo['colore'] %} · Colore: {{ capo['colore'] }}{% endif %}
            {% if capo['brand'] %} · Brand: {{ capo['brand'] }}{% endif %}
          </p>
        </div>
      </article>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

<section id="products" class="section-band-light">
  <div class="section-inner">
    <div class="wardrobe-view-layout">
      <aside class="wardrobe-filters">
        <h3>Filtra capi</h3>

        <div style="margin-bottom: 1.2rem;">
          <label style="font-size: 0.9rem; font-weight: 500;">Categoria</label>
          <select class="filter-select" data-filter="categoria"
                  style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Tutte</option>
            {% for cat in capi|map(attribute='categoria')|unique %}
              {% if cat %}
                <option value="{{ cat }}">{{ cat }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div style="margin-bottom: 1.2rem;">
          <label style="font-size: 0.9rem; font-weight: 500;">Taglia</label>
          <select class="filter-select" data-filter="taglia"
                  style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Tutte</option>
            {% for t in capi|map(attribute='taglia')|unique %}
              {% if t %}
                <option value="{{ t }}">{{ t }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div style="margin-bottom: 1.2rem;">
          <label style="font-size: 0.9rem; font-weight: 500;">Brand</label>
          <select class="filter-select" data-filter="brand"
                  style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Tutti</option>
            {% for b in capi|map(attribute='brand')|unique %}
              {% if b %}
                <option value="{{ b }}">{{ b }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div style="margin-bottom: 1.2rem;">
          <label style="font-size: 0.9rem; font-weight: 500;">Destinazione</label>
          <select class="filter-select" data-filter="destinazione"
                  style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid #ccc;">
            <option value="">Tutte</option>
            {% for d in capi|map(attribute='destinazione')|unique %}
              {% if d %}
                <option value="{{ d }}">{{ d }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <button onclick="resetFilters()" style="
          padding: 0.5rem 1rem;
          background-color: #e6ecf9;
          border: none;
          border-radius: 6px;
          color: #2b4ca3;
          font-weight: 500;
          cursor: pointer;
          margin-top: 1rem;
          width: 100%;
        ">
          Reset filtri
        </button>
      </aside>

      <div class="wardrobe-main">
        <h2>Products</h2>
        <p style="margin-top: 0.5rem; font-size: 0.95rem; color: #555;">
          Tutti i capi caricati dagli Admin.
        </p>

        <p id="item-count" style="margin-top: 0.5rem; font-size: 0.95rem; color: #555;"></p>

        <div class="wardrobe-grid wardrobe-grid-3col">
          {% if capi %}
            {% for capo in capi %}
            <div class="capo-flip-card"
                 data-capo='{{ capo|tojson|safe }}'>
              <div class="capo-flip-inner">
                <div class="capo-flip-front">
                  <img src="{{ url_for('immagini', filename=(capo['immagine'] or '').split('/')[-1]) }}"
                       alt="fronte" class="capo-img">
                </div>
                <div class="capo-flip-back">
                  {% if capo['immagine2'] %}
                    <img src="{{ url_for('immagini', filename=(capo['immagine2'] or '').split('/')[-1]) }}"
                         alt="retro" class="capo-img">
                  {% else %}
                    <p style="text-align:center; font-size: 0.8rem;">Nessuna retro immagine</p>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <p>Nessun capo presente nei wardrobe pubblici al momento.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal dettagli capo -->
<div id="detail-modal" class="stycly-modal" style="display:none;">
  <div class="stycly-modal-content" style="max-width: 900px;">
    <button class="stycly-modal-close" onclick="closeDetailPopup()">&times;</button>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
      <div style="flex: 1; text-align:center;">
        <img id="popup-image" src="" alt="Capo" style="max-width: 100%; max-height: 380px; border-radius: 8px;">
        <div style="margin-top: 10px; display: flex; gap: 0.5rem; justify-content: center;">
          <button onclick="showFront()" class="capo-icon-btn" title="Fronte">F</button>
          <button onclick="showBack()" class="capo-icon-btn" title="Retro">R</button>
        </div>
      </div>
      <div id="popup-details" style="flex:1; font-size: 0.95rem;"></div>
    </div>
  </div>
</div>

<section id="how" class="stycly-how section-band">
  <div class="how-bg"></div>
  <div class="how-card">
    <div class="how-head">
      <h2 class="section-heading">Come funziona il noleggio</h2>
      <p class="how-sub">Seguire il processo di noleggio su Stycly è semplice e veloce. Ecco tutti i passaggi:</p>
    </div>
    <div class="how-steps">
      <div class="how-step">
        <span class="how-number">1</span>
        <div>
          <h4>Cerca i prodotti</h4>
          <p>Naviga in Prodotti e scopri capi, accessori, props e oggetti per bambini.</p>
          <p>Filtra per categoria e guarda i dettagli di ogni articolo.</p>
        </div>
      </div>
      <div class="how-step">
        <span class="how-number">2</span>
        <div>
          <h4>Aggiungi al carrello</h4>
          <p>Scegli gli articoli e la quantità desiderata, poi aggiungili al carrello.</p>
        </div>
      </div>
      <div class="how-step">
        <span class="how-number">3</span>
        <div>
          <h4>Invia una richiesta di noleggio</h4>
          <p>Nel carrello clicca su Avanti e:</p>
          <ul class="how-bullets">
            <li>seleziona le date di noleggio dal calendario (uno o più giorni);</li>
            <li>inserisci i tuoi dati di contatto;</li>
            <li>conferma la richiesta.</li>
          </ul>
        </div>
      </div>
      <div class="how-step">
        <span class="how-number">4</span>
        <div>
          <h4>Ricevi il preventivo</h4>
          <p>Entro 24 ore ti contattiamo via email per confermare disponibilità e inviarti il preventivo personalizzato.</p>
          <p>Completa ordine via email o telefono.</p>
        </div>
      </div>
      <div class="how-step">
        <span class="how-number">5</span>
        <div>
          <h4>Pagamento e fatturazione</h4>
          <p>Pagamento concordato con il nostro operatore (non online al momento) e ricezione della fattura.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="about" class="section-band-light about-placeholder">
  <div class="section-heading-wrap">
    <h2>About Us</h2>
    <p class="section-sub">Presto aggiorneremo questa sezione con la nostra storia e il team.</p>
  </div>
</section>

<section id="contact" class="section-band contact-placeholder">
  <div class="section-heading-wrap">
    <h2>Contact</h2>
    <p class="section-sub">Inseriremo indirizzo, mappa e contatti in questo blocco.</p>
  </div>
</section>

<footer class="stycly-footer">
  <p>© {{ current_year or '2025' }} Stycly. All rights reserved.</p>
</footer>
{% endblock %}

{% block extra_js %}
<script>
// --- helper per immagini (stessa logica di public_wardrobe) ---
function buildImageURLHome(filename) {
  if (!filename) return "";
  const cleanName = filename.toString().split("/").pop();
  return "/immagini/" + cleanName;
}

let qvFront = "";
let qvBack  = "";
let qvQty   = 1;
let qvProduct = null;

function openFeaturedDetail(capo) {
  qvFront = capo.immagine;
  qvBack  = capo.immagine2 || "";
  qvQty   = 1;

  const title = (capo.categoria || '') + (capo.tipologia ? ' - ' + capo.tipologia : '');
  document.getElementById('quickview-title').textContent = title;

  document.getElementById('quickview-subtitle').textContent =
    capo.brand ? capo.brand : '';

  document.getElementById('quickview-description').textContent =
    capo.destinazione ? ('Perfetto per: ' + capo.destinazione) : '';

  document.getElementById('quickview-taglia').textContent       = capo.taglia || '-';
  document.getElementById('quickview-colore').textContent       = capo.colore || '-';
  document.getElementById('quickview-brand').textContent        = capo.brand || '-';
  document.getElementById('quickview-destinazione').textContent = capo.destinazione || '-';
  document.getElementById('quickview-fit').textContent          = capo.fit || '-';
  document.getElementById('quickview-dispo').textContent        = capo.disponibilita || 1;
  document.getElementById('quickview-categoria').textContent    = capo.categoria || '-';

  document.getElementById('quickview-image').src = buildImageURLHome(qvFront);
  document.getElementById('quickview-qty-value').textContent = qvQty;

  qvProduct = {
    id: capo.id,
    name: title,
    img: (capo.immagine || '').toString().split('/').pop()
  };

  document.getElementById('featured-detail-modal').style.display = 'flex';
}

function closeFeaturedDetail() {
  document.getElementById('featured-detail-modal').style.display = 'none';
}

function showFeaturedFront() {
  if (qvFront) {
    document.getElementById('quickview-image').src = buildImageURLHome(qvFront);
  }
}

function showFeaturedBack() {
  if (qvBack) {
    document.getElementById('quickview-image').src = buildImageURLHome(qvBack);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // apertura quick view
  document.querySelectorAll('.featured-info-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const capo = JSON.parse(this.getAttribute('data-capo'));
      openFeaturedDetail(capo);
    });
  });

  // chiusura quick view
  const modal = document.getElementById('featured-detail-modal');
  if (modal) {
    document.getElementById('quickview-close-btn').addEventListener('click', closeFeaturedDetail);
    modal.addEventListener('click', (e) => {
      if (e.target.id === 'featured-detail-modal') {
        closeFeaturedDetail();
      }
    });
  }

  // cambio fronte/retro cliccando sull'immagine
  const qvImage = document.getElementById('quickview-image');
  if (qvImage) {
    qvImage.addEventListener('click', () => {
      if (!qvBack) return;
      const current = qvImage.getAttribute('src');
      const frontURL = buildImageURLHome(qvFront);
      const backURL  = buildImageURLHome(qvBack);
      qvImage.src = (current === frontURL) ? backURL : frontURL;
    });
  }

  // gestione quantità
  const minus = document.getElementById('quickview-minus');
  const plus = document.getElementById('quickview-plus');
  if (minus && plus) {
    minus.addEventListener('click', () => {
      if (qvQty > 1) {
        qvQty--;
        document.getElementById('quickview-qty-value').textContent = qvQty;
      }
    });
    plus.addEventListener('click', () => {
      qvQty++;
      document.getElementById('quickview-qty-value').textContent = qvQty;
    });
  }

  // Add to cart dal popup
  const addCartBtn = document.getElementById('quickview-add-cart');
  if (addCartBtn) {
    addCartBtn.addEventListener('click', () => {
      if (!qvProduct) return;
      if (typeof window.styclyAddToCart !== 'function') {
        alert('Carrello non disponibile al momento.');
        return;
      }
      for (let i = 0; i < qvQty; i++) {
        window.styclyAddToCart(qvProduct);
      }
      closeFeaturedDetail();
    });
  }
});
</script>
<script>
// Attiva voce menu su scroll per le sezioni di questa pagina
document.addEventListener('DOMContentLoaded', () => {
  const navLinks = Array.from(document.querySelectorAll('.stycly-nav a'));
  const sections = Array.from(document.querySelectorAll('section[id]'));

  const activate = (id) => {
    navLinks.forEach(link => {
      const href = link.getAttribute('href') || '';
      if (href.includes(`#${id}`)) {
        link.classList.add('nav-active');
      } else if (href.includes('#')) {
        link.classList.remove('nav-active');
      }
    });
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        activate(entry.target.id);
      }
    });
  }, { rootMargin: '-45% 0px -45% 0px', threshold: 0.1 });

  sections.forEach(sec => observer.observe(sec));

  navLinks.forEach(link => {
    const href = link.getAttribute('href') || '';
    if (href.includes('#')) {
      link.addEventListener('click', (e) => {
        const targetId = href.split('#')[1];
        const target = document.getElementById(targetId);
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
  });
});
</script>
<script>
// Sezione prodotti embedded (filtri + popup)
let frontImg = "";
let backImg  = "";

function buildImageURL(filename) {
  if (!filename) return "";
  const cleanName = filename.toString().split("/").pop();
  return "/immagini/" + cleanName;
}

function openDetailPopup(capo) {
  frontImg = capo.immagine;
  backImg  = capo.immagine2 || "";

  document.getElementById('popup-image').src = buildImageURL(frontImg);
  document.getElementById('popup-details').innerHTML = `
    <p><b>Categoria:</b> ${capo.categoria || ''}</p>
    <p><b>Tipologia:</b> ${capo.tipologia || ''}</p>
    <p><b>Taglia:</b> ${capo.taglia || ''}</p>
    <p><b>Colore:</b> ${capo.colore || ''}</p>
    <p><b>Brand:</b> ${capo.brand || ''}</p>
    <p><b>Destinazione:</b> ${capo.destinazione || ''}</p>
    ${capo.fit ? `<p><b>Fit:</b> ${capo.fit}</p>` : ''}
    <p><b>Disponibilità:</b> ${capo.disponibilita || 1}</p>
  `;
  document.getElementById("detail-modal").style.display = "flex";
}

function closeDetailPopup() {
  document.getElementById("detail-modal").style.display = "none";
}

function showFront() {
  if (frontImg) {
    document.getElementById('popup-image').src = buildImageURL(frontImg);
  }
}

function showBack() {
  if (backImg) {
    document.getElementById('popup-image').src = buildImageURL(backImg);
  }
}

function applyFilters() {
  const filters = {};
  document.querySelectorAll('.filter-select').forEach(select => {
    const key = select.dataset.filter;
    const val = select.value;
    if (val) filters[key] = val;
  });

  let visibleCount = 0;
  document.querySelectorAll('.capo-flip-card').forEach(card => {
    const capo = JSON.parse(card.getAttribute('data-capo'));
    const match = Object.entries(filters).every(([key, val]) => {
      const v = (capo[key] || '').toString().toLowerCase();
      return v === val.toString().toLowerCase();
    });
    card.style.display = match ? 'flex' : 'none';
    if (match) visibleCount++;
  });

  const ic = document.getElementById("item-count");
  if (ic) {
    ic.textContent = `${visibleCount} cap${visibleCount === 1 ? 'o' : 'i'} trovati`;
  }
}

function resetFilters() {
  document.querySelectorAll('.filter-select').forEach(select => {
    select.value = "";
  });
  applyFilters();
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.capo-flip-card').forEach(card => {
    card.addEventListener('click', function () {
      const capo = JSON.parse(this.getAttribute('data-capo'));
      openDetailPopup(capo);
    });
  });

  document.querySelectorAll('.filter-select').forEach(select => {
    select.addEventListener('change', applyFilters);
  });

  applyFilters();
});
</script>
{% endblock %}
