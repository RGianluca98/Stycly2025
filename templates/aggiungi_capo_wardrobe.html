{% extends "base.html" %}
{% block title %}Aggiungi capo{% endblock %}
{% block content %}
<section class="section-band-light add-capo-wrapper">
  <div class="section-inner add-capo-card">
    <div class="add-capo-header">
      <div>
        <p class="add-capo-eyebrow">Private wardrobe</p>
        <h1 class="add-capo-title">Aggiungi un capo</h1>
        <p class="add-capo-sub">
          Inserisci le informazioni del capo per <strong>{{ nome_tabella.replace('wardrobe_', '').replace('_',' ').title() }}</strong>.
          Usa le tendine guidate per mantenere categorie e tag coerenti.
        </p>
      </div>
      <a class="ghost-link" href="{{ url_for('private_wardrobe') }}">← Torna al wardrobe</a>
    </div>

    <form method="post" enctype="multipart/form-data" class="add-capo-form">
      <div class="add-capo-hint">Campi obbligatori con selezione guidata per evitare errori.</div>
      <div class="add-capo-grid">
        <!-- Categoria -->
        <label class="field">
          <span>Categoria</span>
          <div class="psuedo_select" data-name="categoria">
            <span class="selected">-- Seleziona --</span>
            <ul class="options">
              {% for cat in tipologie.keys() %}
                <li class="option" data-value="{{ cat }}">{{ cat }}</li>
              {% endfor %}
            </ul>
          </div>
          <input type="hidden" name="categoria" required>
        </label>

        <!-- Tipologia -->
        <label class="field">
          <span>Tipologia</span>
          <div class="psuedo_select" data-name="tipologia">
            <span class="selected">-- Seleziona --</span>
            <ul class="options"></ul>
          </div>
          <input type="hidden" name="tipologia" required>
        </label>

        <!-- Altri campi -->
        {% for campo, valori in {
          'brand': brands,
          'destinazione': destinazioni,
          'taglia': taglie,
          'colore': colori,
          'fit': fit
        }.items() %}
        <label class="field">
          <span>{{ campo.capitalize() }}</span>
          <div class="psuedo_select" data-name="{{ campo }}">
            <span class="selected">-- Seleziona --</span>
            <ul class="options">
              {% for v in valori %}
                <li class="option" data-value="{{ v }}">{{ v }}</li>
              {% endfor %}
            </ul>
          </div>
          <input type="hidden" name="{{ campo }}" required>
        </label>
        {% endfor %}

        <!-- Quantità -->
        <label class="field">
          <span>Quantita'</span>
          <input
            type="number"
            name="quantita"
            min="1"
            value="1"
            required
            class="add-capo-input">
        </label>

        <!-- Immagini -->
        <label class="field">
          <span>Immagine</span>
          <input type="file" name="immagine" accept="image/*" required class="add-capo-input file-input">
        </label>

        <label class="field">
          <span>Immagine retro (facoltativa)</span>
          <input type="file" name="immagine2" id="immagine2" accept="image/*" class="add-capo-input file-input">
        </label>
      </div>

      <div class="add-capo-actions">
        <a href="{{ url_for('private_wardrobe') }}" class="ghost-link">Annulla</a>
        <button type="submit" class="stycly-cta-btn">Aggiungi capo</button>
      </div>
    </form>
  </div>
</section>

<script>
const tipologie = {{ tipologie|tojson }};

function closeAll() {
  document.querySelectorAll('.psuedo_select .options').forEach(o => o.classList.remove('open'));
  document.querySelectorAll('.field').forEach(f => f.classList.remove('focused'));
}

function setupPsuedoSelect(ps) {
  const name = ps.dataset.name;
  const hidden = document.querySelector(`input[name="${name}"]`);
  const sel = ps.querySelector('.selected');
  const opts = ps.querySelector('.options');

  ps.addEventListener('click', e => {
    e.stopPropagation();
    closeAll();
    ps.parentElement.classList.add('focused');
    opts.classList.add('open');
  });

  opts.querySelectorAll('.option').forEach(li => {
    li.addEventListener('click', e => {
      e.stopPropagation();
      const val = li.dataset.value;
      sel.textContent = li.textContent;
      hidden.value = val;
      closeAll();

      if (name === 'categoria') {
        const tipPs = document.querySelector('.psuedo_select[data-name="tipologia"]');
        const tipUl = tipPs.querySelector('.options');
        const tipSel = tipPs.querySelector('.selected');
        const tipHidden = document.querySelector('input[name="tipologia"]');
        const list = tipologie[val] || [];
        tipUl.innerHTML = '';
        tipSel.textContent = '-- Seleziona --';
        tipHidden.value = '';
        list.forEach(t => {
          const nli = document.createElement('li');
          nli.className = 'option';
          nli.dataset.value = t;
          nli.textContent = t;
          tipUl.appendChild(nli);
        });
        setupPsuedoSelect(tipPs);
      }
    });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.psuedo_select').forEach(setupPsuedoSelect);
  document.addEventListener('click', closeAll);
});
</script>
{% endblock %}
